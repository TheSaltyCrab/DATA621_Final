---
title: "FInal assignment group 4"
author: Deepika Dilip, Tora Mullings, Daniel Sullivan, Deepa Sharma, Bikram Barua,
  Newman Okereafor
date: "2022-11-24"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = F, warning = F, message = F)
```

```{r}
library(tidyverse)
library(ggplot2)
library(ggthemes)
library(corrplot)
library(reshape2)
library(knitr)
library(broom)
library(caret)
library(leaps)
library(MASS)
library(magrittr)
library(betareg)
library(pscl)
library(gtsummary)
library(nnet)
library(readr)
library(fastDummies)
#library(complexHeatmap)
```


## Abstract:

Use 250 words or less to summarize your problem, methodology, and major outcomes.

# Key words:

maternal health, clinical outcomes

# Introduction:

Describe the background and motivation of your problem.

# Literature review:

Discuss how other researchers have addressed similar problems, what their achievements are, and what the advantage and drawbacks of each    reviewed
 
approach are. Explain how your investigation is similar or different to the state-of-the- art. Please cite the relevant papers where appropriate.

# Methodology:

Discuss the key aspects of your problem, data set and regression model(s). Given that you are working on real-world data, explain at a high-level your exploratory data analysis, how you prepared the data for regression modeling, your process for building regression models, and your model selection.

```{r}
MHRD<-read.csv("https://raw.githubusercontent.com/TheSaltyCrab/DATA621_Final/main/Maternal%20Health%20Risk%20Data%20Set.csv")
```


```{r}
head(MHRD,5) %>% kable() %>% kableExtra::kable_styling()
```

### Data Attributes

* `Age`: Any ages in years when a women during pregnant.

* `SystolicBP`: Upper value of Blood Pressure in mmHg, another significant attribute during pregnancy.

* `DiastolicBP`: Lower value of Blood Pressure in mmHg, another significant attribute during pregnancy.

* `BS`: Blood glucose levels is in terms of a molar concentration, mmol/L.

* `HeartRate`: A normal resting heart rate in beats per minute.

* `Risk Level`: Predicted Risk Intensity Level during pregnancy considering the previous attribute.

### Data exploration

```{r}
# MHRD<-MHRD%>% mutate(Risk_num = case_when(
#     str_detect(.$RiskLevel, "low risk") ~ "0",
#     str_detect(.$RiskLevel, "mid risk") ~ "1",
#     str_detect(.$RiskLevel, "high risk") ~ "2",
#     TRUE ~ as.character(.$RiskLevel)))
MHRD = MHRD %>% mutate(RiskLevel = factor(RiskLevel, levels = c("low risk", "mid risk", "high risk")))

```

We can start by making a correlation plot to compare continuous values. Age is positively correlated with systolic and diastolic blood pressure. 

```{r}
corrplot(cor( select_if(MHRD, is.numeric), use = "complete.obs"), tl.col="black", tl.cex=0.6, order='AOE')
```

The first step is visualizing data distribution by risk. Here we can see age is skewed, and the extremities of blood pressure and glucose levels are flagged as high risk.

```{r}
lst.histogram = list()
for (i in names(MHRD)[1:6]) {
  MHRD.sub = MHRD %>% select(i, "RiskLevel")
  colnames(MHRD.sub) = c("value", "RiskLevel")
  lst.histogram[[i]] = ggplot(aes(value, fill = RiskLevel), data = MHRD.sub) + geom_histogram() + labs(x = i, y = "Count") + scale_fill_manual(values = c("low risk" = "navyblue", "mid risk" = "grey", "high risk" = "red"))
}
ggpubr::ggarrange(plotlist = lst.histogram, ncol = 2, nrow = 3)
```

```{r}
ggplot(aes(RiskLevel, fill = RiskLevel), data = MHRD) + geom_bar(stat = "count") + labs(x = "Risk Level", y = "Count") + scale_fill_manual(values = c("low risk" = "navyblue", "mid risk" = "grey", "high risk" = "red")) + labs(title = "Risk Level Counts")
```

One approach we can take is implementing unsupervised clustering since many of the biomarkers are continuous. We can do this by forming a matrix of indicators and seeing if risk levels clusters. From this analysis, we see 6 distinct subgroups: 2 high risk, 3 low risk, and 1 mid risk (with some heterogeneity).

```{r}
mat.MHRD = MHRD %>% select(-c("RiskLevel")) %>% as.matrix()
rownames(mat.MHRD) = rownames(MHRD)
mat.MHRD = t(mat.MHRD)
tree = hclust(dist(t(mat.MHRD), method = "euclidean"))
mat.risk = MHRD %>% select(c("RiskLevel")) %>% as.matrix()
#Heatmap(t(mat.risk), cluster_columns  = tree, cluster_rows = F, col =c("low risk" = "navyblue", "mid risk" = "grey", "high risk" = "red"),  #heatmap_height = unit(2, "cm"), column_split = 6)
```

## multinomial model

```{r}
set.seed(100)
trainingRows <- sample(1:nrow(MHRD), 0.7*nrow(MHRD))
training <- MHRD[trainingRows, ]
test <- MHRD[-trainingRows, ]

#training
```

# Experimentation and Results:

Describe the specifics of what you did (data exploration, data preparation, model building, model selection, model evaluation, etc.), and what you found out (statistical analyses, interpretation and discussion of the results, etc.).


multinomial model 1 (all predictors)
```{r, echo=FALSE}
mn_model<-multinom(RiskLevel ~ ., data=training)
predicted_scores <- predict (mn_model, test, "probs")
predicted_class <- predict (mn_model, test)
table(predicted_class,test$RiskLevel)
print(paste0("accuracy=",mean(as.character(predicted_class) == as.character(test$RiskLevel))))
print(paste0("AIC=",mn_model$AIC))


```
multinomial model 2 (Age, systolic blood pressure, blood sugar)
```{r, echo=FALSE}
mn_model2<-multinom(RiskLevel ~ Age + SystolicBP + BS, data=training)

predicted_scores2 <- predict (mn_model2, test, "probs")
predicted_class2 <- predict (mn_model2, test)
table(predicted_class2,test$RiskLevel)

print(paste0("accuracy=",mean(as.character(predicted_class2) == as.character(test$RiskLevel))))
print(paste0("AIC=",mn_model2$AIC))

```
multinomial model 3 (blood sugar, systolic blood pressure)
```{r, echo=FALSE}
mn_model3<-multinom(RiskLevel ~ BS+SystolicBP, data=training)
mn_model3$AIC

predicted_scores3 <- predict (mn_model3, test, "probs")
predicted_class3 <- predict (mn_model3, test)
table(predicted_class3,test$RiskLevel)

print(paste0("accuracy=",mean(as.character(predicted_class3) == as.character(test$RiskLevel))))
print(paste0("AIC=",mn_model3$AIC))

```
multinomial model 4 (blood sugar)
```{r, echo=FALSE}
mn_model4<-multinom(RiskLevel ~ BS, data=training)


predicted_scores4 <- predict (mn_model4, test, "probs")
predicted_class4 <- predict (mn_model4, test)
table(predicted_class4,test$RiskLevel)

print(paste0("accuracy=",mean(as.character(predicted_class4) == as.character(test$RiskLevel))))
print(paste0("AIC=",mn_model4$AIC))

```
multinomial model 5 (blood sugar, heart rate, body temp, systolic blood pressure)
```{r, echo=FALSE}
mn_model5<-multinom(RiskLevel ~ BS+SystolicBP+ HeartRate+BodyTemp, data=training)


predicted_scores5 <- predict (mn_model5, test, "probs")
predicted_class5 <- predict (mn_model5, test)
table(predicted_class5,test$RiskLevel)

print(paste0("accuracy=",mean(as.character(predicted_class5) == as.character(test$RiskLevel))))
print(paste0("AIC=",mn_model5$AIC))

```
Ordinal model 1 (all variables)

```{r, echo=FALSE}
O_model1<-polr(RiskLevel ~ ., data=training, Hess = TRUE)


predicted_scores_ord1 <- predict (O_model1, test, "probs")
predicted_class_ord1 <- predict (O_model1, test)
table(predicted_class_ord1,test$RiskLevel)

print(paste0("accuracy=",mean(as.character(predicted_class_ord1) == as.character(test$RiskLevel))))
print(paste0("AIC=",O_model1$AIC))

```
Ordinal model 2 (blood sugar, systolic blood pressure, age)
```{r, echo=FALSE}
O_model2<-polr(RiskLevel ~ Age + SystolicBP + BS, data=training, Hess = TRUE)


predicted_scores_ord2 <- predict (O_model2, test, "probs")
predicted_class_ord2 <- predict (O_model2, test)
table(predicted_class_ord2,test$RiskLevel)

print(paste0("accuracy=",mean(as.character(predicted_class_ord2) == as.character(test$RiskLevel))))
print(paste0("AIC=",O_model2$AIC))

```
Ordinal model 3 (blood sugar, systolic blood pressure)
```{r, echo=FALSE}
O_model3<-polr(RiskLevel ~ SystolicBP + BS, data=training, Hess = TRUE)


predicted_scores_ord3 <- predict (O_model3, test, "probs")
predicted_class_ord3 <- predict (O_model3, test)
table(predicted_class_ord3,test$RiskLevel)

print(paste0("accuracy=",mean(as.character(predicted_class_ord3) == as.character(test$RiskLevel))))
print(paste0("AIC=",O_model3$AIC))

```
Ordinal model 4 (blood sugar)
```{r, echo=FALSE}
O_model4<-polr(RiskLevel ~ BS, data=training, Hess = TRUE)


predicted_scores_ord4 <- predict (O_model4, test, "probs")
predicted_class_ord4 <- predict (O_model4, test)
table(predicted_class_ord4,test$RiskLevel)

print(paste0("accuracy=",mean(as.character(predicted_class_ord4) == as.character(test$RiskLevel))))
print(paste0("AIC=",O_model4$AIC))

```



### GLM model construction:

we first took the approach of trying to predict the level of risk involved with pregnancy using multinomial and ordinal regression modeling. Starting with all variables and then paring down based on correlation to risk level as well as co-linearity in predictors. we selected first age, systolic blood pressure, and blood sugar level as our first set of restricted predicors followed by blood suger and systolic blood pressure for our second. Although we expected to improve the prediction rate by only keeping the most correlated predictors both model 2(systolicBP, Age, blood sugar) and model 3(systolicBP, blood sugar) in both multinomial and ordinal regressions showed a decrease in predictive accuracy when compared to models with all predictors. The only model in wich we saw the best improvment of our predictions was when we only included blood sugar as a predictor. Because assessing pregnancy risk is very important topic and could leaad to life saving interventions we want to strengthen this model and suggest more in depth analysis into this data via unsupervised learning methods. 

# Discussion and Conclusions:

Conclude your findings, limitations, and suggest areas for future work.

# References: 

Be sure to cite all references used in the report (APA format).

#   Appendices:
#	Supplemental tables and/or figures.
#	R statistical programming code.
